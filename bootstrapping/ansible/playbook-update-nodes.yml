- name: Update dependencies on master nodes
  hosts: masters
  become: yes
  serial: 1
  tasks:
    - name: Drain the master node
      command: microk8s kubectl drain {{ inventory_hostname }} --ignore-daemonsets --delete-local-data

    - name: Update apt cache on masters
      apt:
        update_cache: yes

    - name: Upgrade all packages on masters
      apt:
        upgrade: dist

    - name: Check if reboot is required on master
      stat:
        path: /var/run/reboot-required
      register: reboot_required

    - name: Reboot master if needed
      reboot:
        reboot_timeout: 300
      when: reboot_required.stat.exists

    - name: Uncordon the master node
      command: microk8s kubectl uncordon {{ inventory_hostname }}
      when: not reboot_required.stat.exists

- name: Update dependencies on worker nodes
  hosts: workers
  become: yes
  serial: 1
  tasks:
    - name: Drain the master node
      command: microk8s kubectl drain {{ inventory_hostname }} --ignore-daemonsets --delete-local-data

    - name: Update apt cache on workers
      apt:
        update_cache: yes

    - name: Upgrade all packages on workers
      apt:
        upgrade: dist

    - name: Check if reboot is required on worker
      stat:
        path: /var/run/reboot-required
      register: reboot_required

    - name: Reboot worker if needed
      reboot:
        reboot_timeout: 300
      when: reboot_required.stat.exists

    - name: Uncordon the master node
      command: microk8s kubectl uncordon {{ inventory_hostname }}
      when: not reboot_required.stat.exists
